#include "ColorTemperature.h"

unsigned char RGB_map [] = {255, 51, 0, 255, 69, 0, 255, 82, 0, 255, 93, 0, 255, 102, 0, 255, 111, 0, 255, 118, 0, 255, 124, 0, 255, 130, 0, 255, 135, 0, 255, 141, 11, 255, 146, 29, 255, 152, 41, 255, 157, 51, 255, 162, 60, 255, 166, 69, 255, 170, 77, 255, 174, 84, 255, 178, 91, 255, 182, 98, 255, 185, 105, 255, 189, 111, 255, 192, 118, 255, 195, 124, 255, 198, 130, 255, 201, 135, 255, 203, 141, 255, 206, 146, 255, 208, 151, 255, 211, 156, 255, 213, 161, 255, 215, 166, 255, 217, 171, 255, 219, 175, 255, 221, 180, 255, 223, 184, 255, 225, 188, 255, 226, 192, 255, 228, 196, 255, 229, 200, 255, 231, 204, 255, 232, 208, 255, 234, 211, 255, 235, 215, 255, 237, 218, 255, 238, 222, 255, 239, 225, 255, 240, 228, 255, 241, 231, 255, 243, 234, 255, 244, 237, 255, 245, 240, 255, 246, 243, 255, 247, 245, 255, 248, 248, 255, 249, 251, 255, 249, 253, 254, 250, 255, 252, 248, 255, 250, 247, 255, 247, 245, 255, 245, 244, 255, 243, 243, 255, 241, 241, 255, 239, 240, 255, 238, 239, 255, 236, 238, 255, 234, 237, 255, 233, 236, 255, 231, 234, 255, 229, 233, 255, 228, 233, 255, 227, 232, 255, 225, 231, 255, 224, 230, 255, 223, 229, 255, 221, 228, 255, 220, 227, 255, 219, 226, 255, 218, 226, 255, 217, 225, 255, 216, 224, 255, 215, 223, 255, 214, 223, 255, 213, 222, 255, 212, 221, 255, 211, 221, 255, 210, 220, 255, 209, 220, 255, 208, 219, 255, 207, 218, 255, 207, 218, 255, 206, 217, 255, 205, 217, 255, 204, 216, 255, 204, 216, 255, 203, 215, 255, 202, 215, 255, 202, 214, 255, 201, 214, 255, 200, 213, 255, 200, 213, 255, 199, 212, 255, 198, 212, 255, 198, 212, 255, 197, 211, 255, 197, 211, 255, 196, 210, 255, 196, 210, 255, 195, 210, 255, 195, 209, 255, 194, 209, 255, 194, 208, 255, 193, 208, 255, 193, 208, 255, 192, 207, 255, 192, 207, 255, 191, 207, 255, 191, 206, 255, 190, 206, 255, 190, 206, 255, 190, 206, 255, 189, 205, 255, 189, 205, 255, 188, 205, 255, 188, 204, 255, 188, 204, 255, 187, 204, 255, 187, 204, 255, 187, 203, 255, 186, 203, 255, 186, 203, 255, 186, 203, 255, 185, 202, 255, 185, 202, 255, 185, 202, 255, 184, 202, 255, 184, 201, 255, 184, 201, 255, 184, 201, 255, 183, 201, 255, 183, 201, 255, 183, 200, 255, 182, 200, 255, 182, 200, 255, 182, 200, 255, 182, 200, 255, 181, 199, 255, 181, 199, 255, 181, 199, 255, 181, 199, 255, 180, 199, 255, 180, 198, 255, 180, 198, 255, 180, 198, 255, 179, 198, 255, 179, 198, 255, 179, 198, 255, 179, 197, 255, 179, 197, 255, 178, 197, 255, 178, 197, 255, 178, 197, 255, 178, 197, 255, 178, 196, 255, 177, 196, 255, 177, 196, 255, 177, 196, 255, 177, 196, 255, 177, 196, 255, 176, 196, 255, 176, 195, 255, 176, 195, 255, 176, 195, 255, 176, 195, 255, 176, 195, 255, 175, 195, 255, 175, 195, 255, 175, 194, 255, 175, 194, 255, 175, 194, 255, 175, 194, 255, 174, 194, 255, 174, 194, 255, 174, 194, 255, 174, 194, 255, 174, 194, 255, 174, 193, 255, 174, 193, 255, 173, 193, 255, 173, 193, 255, 173, 193, 255, 173, 193, 255, 173, 193, 255, 173, 193, 255, 173, 193, 255, 173, 192, 255, 172, 192, 255, 172, 192, 255, 172, 192, 255, 172, 192, 255, 172, 192, 255, 172, 192, 255, 172, 192, 255, 172, 192, 255, 171, 192, 255, 171, 192, 255, 171, 191, 255, 171, 191, 255, 171, 191, 255, 171, 191, 255, 171, 191, 255, 171, 191, 255, 171, 191, 255, 170, 191, 255, 170, 191, 255, 170, 191, 255, 170, 191, 255, 170, 190, 255, 170, 190, 255, 170, 190, 255, 170, 190, 255, 170, 190, 255, 170, 190, 255, 169, 190, 255, 169, 190, 255, 169, 190, 255, 169, 190, 255, 169, 190, 255, 169, 190, 255, 169, 190, 255, 169, 190, 255, 169, 189, 255, 169, 189, 255, 169, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 168, 189, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 167, 188, 255, 166, 188, 255, 166, 188, 255, 166, 188, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 166, 187, 255, 165, 187, 255, 165, 187, 255, 165, 187, 255, 165, 187, 255, 165, 187, 255, 165, 187, 255, 165, 187, 255, 165, 187, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 165, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 186, 255, 164, 185, 255, 164, 185, 255, 164, 185, 255, 164, 185, 255, 164, 185, 255, 164, 185, 255, 164, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 185, 255, 163, 184, 255, 163, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 162, 184, 255, 161, 184, 255, 161, 184, 255, 161, 184, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 161, 183, 255, 155, 188, 255};
int temperature_src = -1;

void getHist( unsigned char * gray,int * hist, int size)
{
	int i;
	memset(hist,0,256*sizeof(int));
	for ( i = 0; i < size; i++)
	{
		hist[gray [i]]++;
	}
}
void histSelect(int * hist, int size, int * max, int * min)
{
	int sum = 0;
	int i = 255;
	int thre = size/800;
	*max = 255;
	*min = 255;
	for ( ; i>0;i--)
	{
		sum += hist[i];
		if (sum >= thre)
		{
			*min = i;
			break;
		}
	}
	//printf("select gray:(%d,%d)\n",*min,*max);
}
void GetWhiteBalancePara1(int * img,unsigned char * gray, int size, unsigned char * para)
{

	int hist[256];
	int gray_max, gray_min ;
	int i;
	int R,G,B, R_mean = 0, G_mean = 0, B_mean = 0, mean;
	int count;


	RGB2GRAY(img,gray,size);
	getHist(gray,hist,size);
	histSelect(hist,size,&gray_max,&gray_min);


	count = 0;
	for(i = 0; i<size; i++)
	{
		if (gray[i]>=gray_min&&gray[i]<=gray_max)
		{
			getRGB(img[i],&R,&G,&B);
			R_mean += R;
			G_mean += G;
			B_mean += B;
			count ++;
		}
 	}
	if (count>0)
	{
 		para[0] = R_mean/count;
		para[1] = G_mean/count;
		para[2] = B_mean/count;
	}
}

void getRate(unsigned char * srcPara, unsigned char * dstPara, int * rate)
{
	int mean1,mean2,i;
	mean1 = (srcPara[0]+srcPara[1]+srcPara[2])/3;
	mean2 = (dstPara[0]+dstPara[1]+dstPara[2])/3;

	for (i=0;i<3;i++)
	{
		rate[i] = (dstPara[i])*mean1/mean2-srcPara[i];
	}

}
int getCurTemperature(int * img,unsigned char * gray, int size, unsigned char * dstPara,int dstPara_num)
{
	int i,j,mean_src,mean_dst;
 	unsigned char para[3] = {0};


	GetWhiteBalancePara1(img,gray,size,para);
	mean_src = (para[0]+para[1]+para[2])/3;


	unsigned int delta,dalta_min = 9999999;

	for (i = 0;i<dstPara_num;i++)
	{
		mean_dst = (dstPara[i*3+0]+dstPara[i*3+1]+dstPara[i*3+2])/3;
 		delta = abs((dstPara[i*3+0] )*mean_src/mean_dst-para[0])
			  + abs((dstPara[i*3+1] )*mean_src/mean_dst-para[1])
			  + abs((dstPara[i*3+2] )*mean_src/mean_dst-para[2]);
		if (delta<dalta_min)
		{
			dalta_min = delta;
			temperature_src = i;
		}
	}
//	temperature_src +=2;

	return temperature_src;
}
unsigned char para[3] = {0};
int ColorTemperature(int * img,int * dst, int size, int temperature)
{

	int t1 = getCurrentTime();

	 if(temperature == -1)//初始化
    {
//		 int t1 =  getCurrentTime();
		 unsigned char * gray = (unsigned char * )malloc(size * sizeof(unsigned char));
		 getCurTemperature(img,gray,size,RGB_map,391);
		 GetWhiteBalancePara1(img,gray,size,para);
		 free(gray);
//		 int t2 =   getCurrentTime();

//		 LOGW("init time  :%d ms\n",t2-t1);


			LOGW("temperature  :%d \n",temperature);
		 	LOGW("temperature_src  :%d \n",temperature_src);
		 return temperature_src;
    }

//	 int t3 =  getCurrentTime();
	int i;
	int R,G,B;

	int rate[3] = {0};




	LOGW("1111temperature  :%d \n",temperature);
 	LOGW("1111temperature_src  :%d \n",temperature_src);


	if(temperature>=57)
	{
		if(abs(temperature-temperature_src)<=5) {}
		else  getRate(para,&RGB_map[(temperature)*3],rate);
	}

	else
	{
		if((temperature-temperature_src)<=5&&(temperature-temperature_src)>=0) {}
		else  getRate(para,&RGB_map[(temperature)*3],rate);
	}

 	for (i =0;i<size;i++)
	{
		getRGB(img[i],&R,&G,&B);

		R = (R + rate[0]);
		G = (G + rate[1]);
		B = (B + rate[2]);

 		R = getMIN(R,255);
		G = getMIN(G,255);
		B = getMIN(B,255);
		R = getMAX(R,0);
		G = getMAX(G,0);
		B = getMAX(B,0);
 		setRGB(&dst[i],R,G,B);
	}
// 	 int t4 =   getCurrentTime();

// 	 LOGW("ColorTemperature time  :%d ms\n",t4-t3);
 	return temperature_src;

}
